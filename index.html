<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IQ 17 - System</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #e0e4e8; font-family: sans-serif; text-align: center; overflow: hidden; }
        canvas { border-bottom: 2px solid #ccc; display: block; margin: 0 auto; touch-action: none; background-color: #f0f2f5; transition: height 0.3s ease; }
        #ui-container { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; transition: transform 0.3s ease; z-index: 50; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        #ui-container.hidden { transform: translateY(180px); }
        #ui { padding: 10px; background: #fff; height: 180px; box-sizing: border-box; overflow-y: auto; }
        #pull-tab { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #fff; border: 1px solid #ccc; border-bottom: none; padding: 5px 20px; border-radius: 10px 10px 0 0; cursor: pointer; font-size: 12px; font-weight: bold; color: #0088cc; }
        #status { position: absolute; top: -65px; left: 0; width: 100%; font-size: 20px; font-weight: 900; text-transform: uppercase; pointer-events: none; text-shadow: 0px 0px 5px rgba(255,255,255,0.8); }
        .btn { padding: 8px 14px; background: #0088cc; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 3px; font-weight: bold; font-size: 12px; }
        #game-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .popup-box { background: white; padding: 25px; border-radius: 15px; color: #333; width: 80%; max-width: 300px; }
        #scoreboard { position: absolute; top: 5px; width: 100%; padding: 0 5px; box-sizing: border-box; pointer-events: none; z-index: 60; display: flex; justify-content: space-between; }
        .score-pill { background: rgba(255, 255, 255, 0.9); padding: 4px 8px; border-radius: 8px; border: 1.5px solid #ccc; width: 100px; display: flex; flex-direction: column; align-items: center; }
        .blue-side { border-color: #2563EB; color: #2563EB; }
        .red-side { border-color: #DC2626; color: #DC2626; }
        #mode-display { font-size: 12px; font-weight: bold; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div id="scoreboard">
        <div id="blue-pill" class="score-pill blue-side"><span id="blue-name">...</span><span id="blue-iq-val">?</span></div>
        <div id="red-pill" class="score-pill red-side"><span id="red-name">...</span><span id="red-iq-val">?</span></div>
    </div>

    <div id="game-overlay">
        <div class="popup-box">
            <h2 id="win-message">WINS!</h2>
            <div id="iq-change-display" style="font-weight:bold; margin: 10px 0;"></div>
            <button class="btn" onclick="location.reload()">New Match</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-container">
        <div id="status">Connecting...</div>
        <div id="pull-tab" onclick="toggleUI()">â–² MENU</div>
        <div id="ui">
            <div id="mode-display">MODE: <span id="current-mode-text" style="color:red">RANKED</span></div>
            <div id="mode-controls">
                <button class="btn" style="background:#DC2626" onclick="setGameMode('ranked')">Ranked</button>
                <button class="btn" style="background:#00AD11" onclick="setGameMode('friendly')">Friendly</button>
            </div>
            <button id="invite-player-btn" class="btn" onclick="inviteTelegramFriend('player')">Invite Friend</button>
            <button class="btn" style="background:#DC2626" onclick="handleSurrender()">Surrender</button>
        </div>
    </div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
const myTelegramName = tg.initDataUnsafe.user ? tg.initDataUnsafe.user.first_name : "Player";
let userScore = 30;
let currentGameMode = 'ranked'; // Default

// Peer & State
let peer = new Peer({ config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }]} });
let conn = null, spectators = [], myRole = null, isRedAssigned = false;

const nodes = {
    0: {x: 200, y: 50}, 8: {x: 320, y: 180}, 11: {x: 240, y: 250}, 16: {x: 220, y: 315},
    28: {x: 180, y: 435}, 32: {x: 160, y: 500}, 38: {x: 80, y: 570}, 43: {x: 200, y: 690}
    // ... [Other nodes would be mapped here based on your scale]
};
// Note: In final implementation, apply scaleX/scaleY to these coordinates as in your previous code.

const roads = [[8,16],[28,38],[11,12],[11,10],[32,29],[32,28],[32,37]]; // Simplified road list for brevity

let gameState = {
    turn: 'blue', pieces: { 0:{team:'blue',type:'king'}, 43:{team:'red',type:'king'}, 11:{team:'blue',type:'x'}, 32:{team:'red',type:'x'} },
    gameOver: false, winner: null
};

function setGameMode(mode) {
    if (myRole !== 'blue') { tg.showAlert("Only host can change mode."); return; }
    currentGameMode = mode;
    document.getElementById('current-mode-text').innerText = mode.toUpperCase();
    document.getElementById('current-mode-text').style.color = (mode === 'ranked') ? 'red' : 'green';
    if (conn) conn.send({ type: 'MODE_CHANGE', mode: mode });
}

function updateScore(isWin, isDraw = false) {
    const display = document.getElementById('iq-change-display');
    if (currentGameMode === 'friendly') {
        display.innerText = "Friendly Match: No IQ Change";
        return;
    }
    let change = isWin ? 10 : -15; // Simplified logic for demo
    userScore += change;
    display.innerText = (change > 0 ? "+" : "") + change + " IQ Change";
    tg.CloudStorage.setItem('player_iq_final_v1', userScore.toString());
}

function getValidMoves(startNode) {
    const piece = gameState.pieces[startNode];
    const valid = [];
    const neighbors = [8, 16, 28, 38, 11, 32]; // Example neighbors

    neighbors.forEach(neighbor => {
        const isPath1 = (startNode === 8 && neighbor === 16) || (startNode === 16 && neighbor === 8);
        const isPath2 = (startNode === 28 && neighbor === 38) || (startNode === 38 && neighbor === 28);
        
        // BLOCKER RULES
        if (isPath1 && gameState.pieces[11]) return; // Node 11 blocks 8-16
        if (isPath2 && gameState.pieces[32]) return; // Node 32 blocks 28-38
        
        valid.push(neighbor);
    });
    return valid;
}

function handleInteraction(id) {
    if (gameState.gameOver || (myRole && gameState.turn !== myRole)) return;
    // ... Move logic ...
    // On Win:
    // gameState.gameOver = true;
    // gameState.winner = gameState.turn;
    // updateScore(myRole === gameState.winner);
    // broadcastState();
}

function setupConnection(){
    conn.on('data', d => {
        if(d.type === 'MODE_CHANGE') {
            currentGameMode = d.mode;
            document.getElementById('current-mode-text').innerText = d.mode.toUpperCase();
            document.getElementById('current-mode-text').style.color = (d.mode === 'ranked') ? 'red' : 'green';
            tg.showAlert("Match mode: " + d.mode.toUpperCase());
        }
        if(!d.type) { gameState = d; if(gameState.gameOver) showWinPopup(gameState.winner); }
    });
}

// PeerJS boilerplate
peer.on('open', id => {
    const p = tg.initDataUnsafe.start_param;
    if(p) { conn = peer.connect(p); myRole = 'red'; setupConnection(); }
    else { myRole = 'blue'; }
});
peer.on('connection', c => { conn = c; isRedAssigned = true; setupConnection(); });

function toggleUI() { document.getElementById('ui-container').classList.toggle('hidden'); }
function inviteTelegramFriend(t){ tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/Iq17game_bot/IQ17?startapp=${peer.id}`); }

</script>
</body>
</html>

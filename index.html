<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IQ 17 - Real-Time Live Stream</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #e0e4e8; font-family: sans-serif; text-align: center; overflow: hidden; }
        canvas { 
            border-bottom: 2px solid #ccc; 
            display: block; 
            margin: 0 auto; 
            touch-action: none; 
            background-color: #f0f2f5;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3BaseFilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/feTurbulence%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
        }
        #ui-container { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; transition: transform 0.3s ease; z-index: 50; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        #ui-container.hidden { transform: translateY(140px); }
        #ui { padding: 10px; background: #fff; height: 140px; box-sizing: border-box; }
        #pull-tab { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #fff; border: 1px solid #ccc; border-bottom: none; padding: 5px 20px; border-radius: 10px 10px 0 0; cursor: pointer; font-size: 12px; font-weight: bold; color: #0088cc; }
        #status { position: absolute; top: -65px; left: 0; width: 100%; font-size: 22px; font-weight: 900; text-transform: uppercase; pointer-events: none; text-shadow: 0px 0px 5px rgba(255,255,255,0.8); }
        .btn { padding: 10px 18px; background: #0088cc; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 3px; font-weight: bold; font-size: 14px; }
        #game-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .popup-box { background: white; padding: 30px; border-radius: 15px; color: #333; width: 80%; max-width: 300px; }
        #scoreboard { position: absolute; top: 5px; width: 100%; padding: 0 5px; box-sizing: border-box; pointer-events: none; z-index: 60; display: flex; justify-content: space-between; }
        .score-pill { background: rgba(255, 255, 255, 0.9); padding: 4px 8px; border-radius: 8px; border: 1.5px solid #ccc; width: 100px; display: flex; flex-direction: column; align-items: center; }
        .blue-side { border-color: #2563EB; color: #2563EB; }
        .red-side { border-color: #DC2626; color: #DC2626; }
        .p-name { font-weight: 800; font-size: 10px; text-transform: uppercase; }
        .p-iq { font-size: 9px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="scoreboard">
        <div class="score-pill blue-side"><span id="blue-name" class="p-name">BLUE</span><span class="p-iq">IQ: <span id="blue-iq-val">30</span></span></div>
        <div class="score-pill red-side"><span id="red-name" class="p-name">RED</span><span class="p-iq">IQ: <span id="red-iq-val">?</span></span></div>
    </div>

    <div id="game-overlay">
        <div class="popup-box">
            <h2 id="win-message">WINS!</h2>
            <div id="iq-change-display"></div>
            <button class="btn" style="background:#00AD11" onclick="handleRematchRequest()">Rematch</button>
            <button class="btn" style="background:#888" onclick="location.reload()">Exit</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-container">
        <div id="status">Connecting...</div>
        <div id="pull-tab" onclick="toggleUI()">â–² MENU</div>
        <div id="ui">
            <button class="btn" onclick="inviteTelegramFriend('player')">Invite Friend</button>
            <button class="btn" style="background:#555" onclick="inviteTelegramFriend('spectator')">Live Stream</button>
            <button class="btn" style="background:#DC2626" onclick="handleSurrender()">Surrender</button>
            <button class="btn" style="background:#f39c12" onclick="handleDrawRequest()">Offer Draw</button>
        </div>
    </div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const statusDiv = document.getElementById('status');
const overlay = document.getElementById('game-overlay');
const winMsg = document.getElementById('win-message');
const uiContainer = document.getElementById('ui-container');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight - 140;
const scaleX = canvas.width / 400;
const scaleY = canvas.height / 700;

// Nodes and Roads (Including your new straight paths)
const nodes = {0: {x: 200*scaleX, y: 50*scaleY}, 1: {x: 80*scaleX, y: 110*scaleY}, 2: {x: 160*scaleX, y: 110*scaleY}, 3: {x: 240*scaleX, y: 110*scaleY}, 4: {x: 320*scaleX, y: 110*scaleY}, 5: {x: 80*scaleX, y: 180*scaleY}, 6: {x: 160*scaleX, y: 180*scaleY}, 7: {x: 240*scaleX, y: 180*scaleY}, 8: {x: 320*scaleX, y: 180*scaleY}, 9: {x: 80*scaleX, y: 250*scaleY}, 10: {x: 160*scaleX, y: 250*scaleY}, 11: {x: 240*scaleX, y: 250*scaleY}, 12: {x: 320*scaleX, y: 250*scaleY}, 13: {x: 25*scaleX, y: 315*scaleY}, 14: {x: 102.5*scaleX, y: 315*scaleY}, 15: {x: 180*scaleX, y: 315*scaleY}, 16: {x: 220*scaleX, y: 315*scaleY}, 17: {x: 297.5*scaleX, y: 315*scaleY}, 18: {x: 375*scaleX, y: 315*scaleY}, 19: {x: 25*scaleX, y: 375*scaleY}, 20: {x: 102.5*scaleX, y: 375*scaleY}, 21: {x: 180*scaleX, y: 375*scaleY}, 22: {x: 220*scaleX, y: 375*scaleY}, 23: {x: 297.5*scaleX, y: 375*scaleY}, 24: {x: 375*scaleX, y: 375*scaleY}, 30: {x: 25*scaleX, y: 435*scaleY}, 29: {x: 102.5*scaleX, y: 435*scaleY}, 28: {x: 180*scaleX, y: 435*scaleY}, 27: {x: 220*scaleX, y: 435*scaleY}, 26: {x: 297.5*scaleX, y: 435*scaleY}, 25: {x: 375*scaleX, y: 435*scaleY}, 31: {x: 80*scaleX, y: 500*scaleY}, 32: {x: 160*scaleX, y: 500*scaleY}, 33: {x: 240*scaleX, y: 500*scaleY}, 34: {x: 320*scaleX, y: 500*scaleY}, 38: {x: 80*scaleX, y: 570*scaleY}, 37: {x: 160*scaleX, y: 570*scaleY}, 36: {x: 240*scaleX, y: 570*scaleY}, 35: {x: 320*scaleX, y: 570*scaleY}, 39: {x: 80*scaleX, y: 640*scaleY}, 40: {x: 160*scaleX, y: 640*scaleY}, 41: {x: 240*scaleX, y: 640*scaleY}, 42: {x: 320*scaleX, y: 640*scaleY}, 43: {x: 200*scaleX, y: 690*scaleY}};
const roads = [[0,2],[0,3],[1,2],[2,3],[3,4],[1,5],[2,6],[3,7],[4,8],[5,6],[6,7],[7,8],[5,9],[6,10],[7,11],[8,12],[9,10],[10,11],[11,12],[2,5],[3,6],[6,9],[4,7],[7,10],[8,11],[9,13],[9,14],[10,14],[10,15],[11,16],[11,17],[12,18],[12,17],[13,14],[14,15],[16,17],[17,18],[13,19],[14,20],[15,21],[16,22],[17,23],[18,24],[19,20],[20,21],[22,23],[23,24],[19,30],[20,29],[21,28],[22,27],[23,26],[24,25],[30,29],[29,28],[27,26],[26,25],[15,22],[21,27],[31,30],[31,29],[32,29],[32,28],[33,27],[33,26],[34,26],[34,25],[31,32],[32,33],[33,34],[31,38],[32,37],[33,36],[34,35],[38,37],[37,36],[36,35],[38,39],[37,40],[36,41],[35,42],[39,40],[40,41],[41,42],[40,43],[41,43],[38,32],[39,37],[37,33],[40,36],[36,34],[41,35],[18,23],[23,27],[16,23],[23,25],[13,20],[20,28],[15,20],[20,30],[38,28],[8,16]];

let peer = new Peer();
let conn = null, spectators = [], myRole = null, isRedAssigned = false;

const initialGameState = () => ({
    turn: 'blue', pieces: {0:{team:'blue',type:'king'}, 3:{team:'blue',type:'triangle'}, 4:{team:'blue',type:'triangle'}, 5:{team:'blue',type:'square'}, 6:{team:'blue',type:'square'}, 7:{team:'blue',type:'square'}, 8:{team:'blue',type:'square'}, 9:{team:'blue',type:'x'}, 10:{team:'blue',type:'x'}, 11:{team:'blue',type:'x'}, 12:{team:'blue',type:'x'}, 43:{team:'red',type:'king'}, 39:{team:'red',type:'triangle'}, 40:{team:'red',type:'triangle'}, 35:{team:'red',type:'square'}, 36:{team:'red',type:'square'}, 37:{team:'red',type:'square'}, 38:{team:'red',type:'square'}, 31:{team:'red',type:'x'}, 32:{team:'red',type:'x'}, 33:{team:'red',type:'x'}, 34:{team:'red',type:'x'}},
    gameOver: false, winner: null
});
let gameState = initialGameState();

// SYNCING LOGIC
function broadcastState() {
    if (conn && conn.open) conn.send(gameState);
    spectators.forEach(s => { if (s.open) s.send(gameState); });
}

function handleSurrender() {
    if (gameState.gameOver || myRole === 'spectator') return;
    gameState.gameOver = true;
    gameState.winner = (myRole === 'blue' ? 'red' : 'blue');
    broadcastState();
    showWinPopup(gameState.winner);
}

function handleDrawRequest() {
    if (conn && conn.open) conn.send({type: 'DRAW_OFFER'});
}

function getValidMoves(nodeId) {
    const p = gameState.pieces[nodeId];
    if (!p) return [];
    const isSpecial = (p.type === 'king' || p.type === 'triangle');
    let moves = roads.filter(r => r.includes(nodeId)).map(r => r[0] === nodeId ? r[1] : r[0]);
    
    // Filter the straight restricted paths
    return moves.filter(m => {
        const isRestricted = (nodeId === 38 && m === 28) || (nodeId === 28 && m === 38) || (nodeId === 8 && m === 16) || (nodeId === 16 && m === 8);
        if (isRestricted && !isSpecial) return false;
        return true;
    });
}

function setupConnection(c) {
    c.on('data', d => {
        if (d.type === 'DRAW_OFFER') {
            tg.showConfirm("Accept Draw?", ok => { if(ok){ gameState.gameOver=true; gameState.winner='draw'; broadcastState(); showWinPopup('draw'); } });
        } else if (d.type === 'INFO') {
            document.getElementById(d.role + '-name').innerText = d.name;
        } else {
            gameState = d;
            // HOST RELAY: If I'm the host, send Guest's move to all Spectators immediately
            if (myRole === 'blue') {
                spectators.forEach(s => { if (s.open) s.send(gameState); });
            }
            if (gameState.gameOver) showWinPopup(gameState.winner);
            drawBoard(); updateStatus();
        }
    });
}

peer.on('open', id => {
    const p = tg.initDataUnsafe.start_param;
    if (p) {
        if (p.startsWith('spec_')) {
            myRole = 'spectator';
            conn = peer.connect(p.replace('spec_', ''));
            setupConnection(conn);
        } else {
            myRole = 'red';
            conn = peer.connect(p);
            setupConnection(conn);
            conn.on('open', () => conn.send({type:'INFO', role:'red', name: tg.initDataUnsafe.user?.first_name || 'Guest'}));
        }
    } else {
        myRole = 'blue';
        document.getElementById('blue-name').innerText = tg.initDataUnsafe.user?.first_name || 'Host';
    }
});

peer.on('connection', c => {
    if (c.metadata && c.metadata.type === 'spectator' || myRole === 'blue' && isRedAssigned) {
        spectators.push(c);
        c.on('open', () => c.send(gameState));
    } else {
        conn = c; isRedAssigned = true;
        setupConnection(conn);
    }
});

function drawBoard() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    roads.forEach(r => {
        const special = (r[0] === 38 && r[1] === 28) || (r[0] === 8 && r[1] === 16);
        ctx.beginPath();
        ctx.setLineDash(special ? [5,5] : []);
        ctx.strokeStyle = special ? '#0088cc' : '#7a869a';
        ctx.moveTo(nodes[r[0]].x, nodes[r[0]].y);
        ctx.lineTo(nodes[r[1]].x, nodes[r[1]].y);
        ctx.stroke();
    });
    for (let id in gameState.pieces) {
        const p = gameState.pieces[id];
        ctx.beginPath();
        ctx.arc(nodes[id].x, nodes[id].y, 15, 0, 7);
        ctx.fillStyle = p.team === 'blue' ? '#2563EB' : '#DC2626';
        ctx.fill();
        ctx.fillStyle = 'white';
        ctx.textAlign = 'center';
        ctx.fillText(p.type === 'king' ? 'K' : p.type === 'triangle' ? 'T' : 'X', nodes[id].x, nodes[id].y + 5);
    }
}

function updateStatus() {
    statusDiv.innerText = gameState.gameOver ? "GAME OVER" : gameState.turn.toUpperCase() + " TURN";
}

function showWinPopup(w) {
    winMsg.innerText = w === 'draw' ? "DRAW" : w.toUpperCase() + " WINS!";
    overlay.style.display = 'flex';
}

function toggleUI() { uiContainer.classList.toggle('hidden'); }
function inviteTelegramFriend(type) {
    const url = `https://t.me/Iq17game_bot/IQ17?startapp=${type === 'spectator' ? 'spec_' + peer.id : peer.id}`;
    tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(url)}`);
}

// Simple click handler for demo
canvas.onclick = (e) => {
    if (myRole === 'spectator') return;
    // (Actual movement logic here as per your previous versions)
    broadcastState();
    drawBoard();
};

drawBoard();
</script>
</body>
</html>

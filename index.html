<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IQ 17 - Private Match</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #e0e4e8; font-family: sans-serif; text-align: center; overflow: hidden; }
        canvas { border-bottom: 2px solid #ccc; display: block; margin: 0 auto; touch-action: none; background-color: #f0f2f5; }
        #ui-container { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; transition: transform 0.3s ease; z-index: 50; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        #ui-container.hidden { transform: translateY(140px); }
        #ui { padding: 10px; background: #fff; height: 140px; box-sizing: border-box; overflow-y: auto; }
        #pull-tab { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #fff; border: 1px solid #ccc; border-bottom: none; padding: 5px 20px; border-radius: 10px 10px 0 0; cursor: pointer; font-size: 12px; font-weight: bold; color: #0088cc; }
        #status { position: absolute; top: -65px; left: 0; width: 100%; font-size: 22px; font-weight: 900; text-transform: uppercase; pointer-events: none; text-shadow: 0px 0px 5px rgba(255,255,255,0.8); }
        .btn { padding: 10px 18px; background: #0088cc; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 3px; font-weight: bold; font-size: 14px; }
    </style>
</head>
<body>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-container">
        <div id="status">Connecting...</div>
        <div id="pull-tab" onclick="toggleUI()">â–² MENU</div>
        <div id="ui">
            <button class="btn" onclick="inviteTelegramFriend('player')">Invite Friend</button>
            <button class="btn" style="background:#DC2626" onclick="handleSurrender()">Surrender</button>
        </div>
    </div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const nodes = {
    0: {x: 200, y: 50}, 1: {x: 80, y: 110}, 2: {x: 160, y: 110}, 3: {x: 240, y: 110}, 4: {x: 320, y: 110}, 
    5: {x: 80, y: 180}, 6: {x: 160, y: 180}, 7: {x: 240, y: 180}, 8: {x: 320, y: 180}, 
    9: {x: 80, y: 250}, 10: {x: 160, y: 250}, 11: {x: 240, y: 250}, 12: {x: 320, y: 250}, 
    13: {x: 25, y: 315}, 14: {x: 102.5, y: 315}, 15: {x: 180, y: 315}, 16: {x: 220, y: 315}, 17: {x: 297.5, y: 315}, 18: {x: 375, y: 315}, 
    19: {x: 25, y: 375}, 20: {x: 102.5, y: 375}, 21: {x: 180, y: 375}, 22: {x: 220, y: 375}, 23: {x: 297.5, y: 375}, 24: {x: 375, y: 375}, 
    30: {x: 25, y: 435}, 29: {x: 102.5, y: 435}, 28: {x: 180, y: 435}, 27: {x: 220, y: 435}, 26: {x: 297.5, y: 435}, 25: {x: 375, y: 435}, 
    31: {x: 80, y: 500}, 32: {x: 160, y: 500}, 33: {x: 240, y: 500}, 34: {x: 320, y: 500}, 
    38: {x: 80, y: 570}, 37: {x: 160, y: 570}, 36: {x: 240, y: 570}, 35: {x: 320, y: 570}, 
    39: {x: 80, y: 640}, 40: {x: 160, y: 640}, 41: {x: 240, y: 640}, 42: {x: 320, y: 640}, 43: {x: 200, y: 690}
};

const roads = [[0,2],[0,3],[1,2],[2,3],[3,4],[1,5],[2,6],[3,7],[4,8],[5,6],[6,7],[7,8],[5,9],[6,10],[7,11],[8,12],[9,10],[10,11],[11,12],[2,5],[3,6],[6,9],[4,7],[7,10],[8,11],[9,13],[9,14],[10,14],[10,15],[11,16],[11,17],[12,18],[12,17],[13,14],[14,15],[16,17],[17,18],[13,19],[14,20],[15,21],[16,22],[17,23],[18,24],[19,20],[20,21],[22,23],[23,24],[19,30],[20,29],[21,28],[22,27],[23,26],[24,25],[30,29],[29,28],[27,26],[26,25],[15,22],[21,27],[31,30],[31,29],[32,29],[32,28],[33,27],[33,26],[34,26],[34,25],[31,32],[32,33],[33,34],[31,38],[32,37],[33,36],[34,35],[38,37],[37,36],[36,35],[38,39],[37,40],[36,41],[35,42],[39,40],[40,41],[41,42],[40,43],[41,43],[38,32],[39,37],[37,33],[40,36],[36,34],[41,35],[18,23],[23,27],[16,23],[23,25],[13,20],[20,28],[15,20],[20,30]];

let gameState = {
    turn: 'blue', selectedNode: null, lastMove: null, gameOver: false,
    pieces: {
        0:{team:'blue',type:'king'}, 3:{team:'blue',type:'triangle'}, 4:{team:'blue',type:'triangle'},
        43:{team:'red',type:'king'}, 39:{team:'red',type:'triangle'}, 40:{team:'red',type:'triangle'}
        // ... (other pieces)
    }
};

function getValidMoves(startNode) {
    if (startNode === null) return [];
    const piece = gameState.pieces[startNode];
    let valid = [], visited = new Map();
    const isSpecialPiece = (piece.type === 'triangle' || piece.type === 'king');
    const maxDist = isSpecialPiece ? 3 : 1; 
    let queue = [{id: startNode, dist: 0, lastNode: null}];
    visited.set(startNode, 0);

    while (queue.length > 0) {
        let current = queue.shift();
        if (current.dist >= maxDist) continue;
        let neighbors = roads.filter(r => r.includes(current.id)).map(r => r[0] === current.id ? r[1] : r[0]);
        
        neighbors.forEach(neighbor => {
            // THE SPECIFIC BYPASS RULE
            const isBypassMove = (current.id === 38 && neighbor === 28) || (current.id === 8 && neighbor === 16);

            if (isSpecialPiece && current.lastNode !== null && !isBypassMove) {
                const p1 = nodes[current.lastNode], p2 = nodes[current.id], p3 = nodes[neighbor];
                const angle1 = Math.atan2(p2.y - p1.y, p2.x - p1.x);
                const angle2 = Math.atan2(p3.y - p2.y, p3.x - p2.x);
                let diff = Math.abs(angle1 - angle2);
                if (diff > Math.PI) diff = 2 * Math.PI - diff;
                
                // FIXED: Using 17 degrees as requested
                if ((diff * 180 / Math.PI) > 17) return; 
            }

            if (!visited.has(neighbor)) {
                const targetPiece = gameState.pieces[neighbor];
                if (targetPiece) {
                    if (targetPiece.team !== piece.team) valid.push(neighbor);
                    visited.set(neighbor, current.dist + 1);
                } else {
                    valid.push(neighbor); visited.set(neighbor, current.dist + 1);
                    queue.push({id: neighbor, dist: current.dist + 1, lastNode: current.id});
                }
            }
        });
    }
    return [...new Set(valid)];
}

// UI RENDER LOGIC
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight - 140;

function drawBoard() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = '#7a869a';
    roads.forEach(p => {
        ctx.beginPath();
        ctx.moveTo(nodes[p[0]].x, nodes[p[0]].y);
        ctx.lineTo(nodes[p[1]].x, nodes[p[1]].y);
        ctx.stroke();
    });
    // Draw pieces and possible moves...
}
drawBoard();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>IQ 17 - 19 Degree Rule</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #fff; font-family: sans-serif; text-align: center; overflow: hidden; }
        canvas { border-bottom: 2px solid #ccc; display: block; margin: 0 auto; touch-action: none; background: #ffffff; transition: height 0.3s ease; }
        #ui-container { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; transition: transform 0.3s ease; z-index: 50; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        #ui-container.hidden { transform: translateY(140px); }
        #ui { padding: 10px; background: #fff; height: 140px; box-sizing: border-box; }
        #pull-tab { position: absolute; top: -30px; left: 50%; transform: translateX(-50%); background: #fff; border: 1px solid #ccc; border-bottom: none; padding: 5px 20px; border-radius: 10px 10px 0 0; cursor: pointer; font-size: 12px; font-weight: bold; color: #0088cc; }
        .btn { padding: 12px 24px; background: #0088cc; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 5px; font-weight: bold; font-size: 16px; }
        #status { font-size: 18px; font-weight: bold; color: #333; margin-bottom: 5px; text-transform: uppercase; }
        #game-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; flex-direction: column; justify-content: center; align-items: center; color: white; }
        .popup-box { background: white; padding: 30px; border-radius: 15px; color: #333; width: 80%; max-width: 300px; }
    </style>
</head>
<body>

    <div id="game-overlay">
        <div class="popup-box">
            <h2 id="win-message">BLUE WINS!</h2>
            <button class="btn" style="background:#00AD11" onclick="triggerRestart()">Restart</button>
            <button class="btn" style="background:#888" onclick="document.getElementById('game-overlay').style.display='none'">Close</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="ui-container">
        <div id="pull-tab" onclick="toggleUI()">â–² MENU</div>
        <div id="ui">
            <div id="status">Connecting...</div>
            <div id="menu">
                <button id="invite-player-btn" class="btn" onclick="inviteTelegramFriend('player')">Invite Friend</button>
                <button id="invite-spec-btn" class="btn" style="background:#555" onclick="inviteTelegramFriend('spectator')">Spectators</button>
            </div>
        </div>
    </div>

<script>
const tg = window.Telegram.WebApp;
tg.expand();

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const statusDiv = document.getElementById('status');
const overlay = document.getElementById('game-overlay');
const winMsg = document.getElementById('win-message');
const invitePlayerBtn = document.getElementById('invite-player-btn');
const uiContainer = document.getElementById('ui-container');
const pullTab = document.getElementById('pull-tab');

canvas.width = window.innerWidth;
canvas.height = window.innerHeight - 140;

const scaleX = canvas.width / 400;
const scaleY = canvas.height / 700;

const nodes = {
    0: {x: 200*scaleX, y: 50*scaleY}, 1: {x: 80*scaleX, y: 110*scaleY}, 2: {x: 160*scaleX, y: 110*scaleY}, 3: {x: 240*scaleX, y: 110*scaleY}, 4: {x: 320*scaleX, y: 110*scaleY}, 
    5: {x: 80*scaleX, y: 180*scaleY}, 6: {x: 160*scaleX, y: 180*scaleY}, 7: {x: 240*scaleX, y: 180*scaleY}, 8: {x: 320*scaleX, y: 180*scaleY}, 
    9: {x: 80*scaleX, y: 250*scaleY}, 10: {x: 160*scaleX, y: 250*scaleY}, 11: {x: 240*scaleX, y: 250*scaleY}, 12: {x: 320*scaleX, y: 250*scaleY}, 
    13: {x: 25*scaleX, y: 315*scaleY}, 14: {x: 102.5*scaleX, y: 315*scaleY}, 15: {x: 180*scaleX, y: 315*scaleY}, 16: {x: 220*scaleX, y: 315*scaleY}, 17: {x: 297.5*scaleX, y: 315*scaleY}, 18: {x: 375*scaleX, y: 315*scaleY}, 
    19: {x: 25*scaleX, y: 375*scaleY}, 20: {x: 102.5*scaleX, y: 375*scaleY}, 21: {x: 180*scaleX, y: 375*scaleY}, 22: {x: 220*scaleX, y: 375*scaleY}, 23: {x: 297.5*scaleX, y: 375*scaleY}, 24: {x: 375*scaleX, y: 375*scaleY}, 
    30: {x: 25*scaleX, y: 435*scaleY}, 29: {x: 102.5*scaleX, y: 435*scaleY}, 28: {x: 180*scaleX, y: 435*scaleY}, 27: {x: 220*scaleX, y: 435*scaleY}, 26: {x: 297.5*scaleX, y: 435*scaleY}, 25: {x: 375*scaleX, y: 435*scaleY}, 
    31: {x: 80*scaleX, y: 500*scaleY}, 32: {x: 160*scaleX, y: 500*scaleY}, 33: {x: 240*scaleX, y: 500*scaleY}, 34: {x: 320*scaleX, y: 500*scaleY}, 
    38: {x: 80*scaleX, y: 570*scaleY}, 37: {x: 160*scaleX, y: 570*scaleY}, 36: {x: 240*scaleX, y: 570*scaleY}, 35: {x: 320*scaleX, y: 570*scaleY}, 
    39: {x: 80*scaleX, y: 640*scaleY}, 40: {x: 160*scaleX, y: 640*scaleY}, 41: {x: 240*scaleX, y: 640*scaleY}, 42: {x: 320*scaleX, y: 640*scaleY}, 43: {x: 200*scaleX, y: 690*scaleY}
};

const roads = [[0,2],[0,3],[1,2],[2,3],[3,4],[1,5],[2,6],[3,7],[4,8],[5,6],[6,7],[7,8],[5,9],[6,10],[7,11],[8,12],[9,10],[10,11],[11,12],[2,5],[3,6],[6,9],[4,7],[7,10],[8,11],[9,13],[9,14],[10,14],[10,15],[11,16],[11,17],[12,18],[12,17],[13,14],[14,15],[16,17],[17,18],[13,19],[14,20],[15,21],[16,22],[17,23],[18,24],[19,20],[20,21],[22,23],[23,24],[19,30],[20,29],[21,28],[22,27],[23,26],[24,25],[30,29],[29,28],[27,26],[26,25],[15,22],[21,27],[31,30],[31,29],[32,29],[32,28],[33,27],[33,26],[34,26],[34,25],[31,32],[32,33],[33,34],[31,38],[32,37],[33,36],[34,35],[38,37],[37,36],[36,35],[38,39],[37,40],[36,41],[35,42],[39,40],[40,41],[41,42],[40,43],[41,43],[38,32],[39,37],[37,33],[40,36],[36,34],[41,35],[18,23],[23,27],[16,23],[23,25],[13,20],[20,28],[15,20],[20,30]];

let peer = new Peer({ config: {'iceServers': [{ 'urls': 'stun:stun.l.google.com:19302' }, { 'urls': 'turn:global.relay.metered.ca:443', 'username': '12086455af0334c526b9d3da', 'credential': 'ZxLMG6ZJX9R7oyQE' }], 'iceTransportPolicy': 'relay' } });
let conn = null, spectators = [], myRole = null;

const initialGameState = () => ({
    turn: 'blue', selectedNode: null, lastMove: null, gameOver: false,
    pieces: {
        0:{team:'blue',type:'king'}, 3:{team:'blue',type:'triangle'}, 4:{team:'blue',type:'triangle'},
        5:{team:'blue',type:'square'}, 6:{team:'blue',type:'square'}, 7:{team:'blue',type:'square'}, 8:{team:'blue',type:'square'},
        9:{team:'blue',type:'x'}, 10:{team:'blue',type:'x'}, 11:{team:'blue',type:'x'}, 12:{team:'blue',type:'x'},
        43:{team:'red',type:'king'}, 39:{team:'red',type:'triangle'}, 40:{team:'red',type:'triangle'},
        35:{team:'red',type:'square'}, 36:{team:'red',type:'square'}, 37:{team:'red',type:'square'}, 38:{team:'red',type:'square'},
        31:{team:'red',type:'x'}, 32:{team:'red',type:'x'}, 33:{team:'red',type:'x'}, 34:{team:'red',type:'x'}
    }
});

let gameState = initialGameState();

function getValidMoves(startNode) {
    if (startNode === null) return [];
    const piece = gameState.pieces[startNode];
    let valid = [], visited = new Map();
    const isSpecialPiece = (piece.type === 'triangle' || piece.type === 'king');
    const maxDist = isSpecialPiece ? 3 : 1; 
    let queue = [{id: startNode, dist: 0, lastNode: null}];
    visited.set(startNode, 0);

    while (queue.length > 0) {
        let current = queue.shift();
        if (current.dist >= maxDist) continue;
        let neighbors = roads.filter(r => r.includes(current.id)).map(r => r[0] === current.id ? r[1] : r[0]);

        neighbors.forEach(neighbor => {
            if (neighbor === 0 || neighbor === 43) {
                const targetPiece = gameState.pieces[neighbor];
                if (piece.type !== 'king') {
                    const isEnemyChamber = (piece.team === 'blue' && neighbor === 43) || (piece.team === 'red' && neighbor === 0);
                    if (isEnemyChamber) { if (!targetPiece || targetPiece.team === piece.team) return; } else { return; }
                } else { if (targetPiece && targetPiece.team === piece.team) return; }
            }
            // Zigzag Angle Rule updated to 19 degrees
            if (isSpecialPiece && current.lastNode !== null) {
                const p1 = nodes[current.lastNode], p2 = nodes[current.id], p3 = nodes[neighbor];
                const angle1 = Math.atan2(p2.y - p1.y, p2.x - p1.x), angle2 = Math.atan2(p3.y - p2.y, p3.x - p2.x);
                let diff = Math.abs(angle1 - angle2);
                if (diff > Math.PI) diff = 2 * Math.PI - diff;
                if ((diff * 180 / Math.PI) > 19) return; 
            }
            if (!visited.has(neighbor)) {
                const targetPiece = gameState.pieces[neighbor];
                if (piece.type === 'x') {
                    const isBackward = piece.team === 'blue' ? nodes[neighbor].y < nodes[startNode].y : nodes[neighbor].y > nodes[startNode].y;
                    const isBridge = (startNode == 15 && neighbor == 22) || (startNode == 22 && neighbor == 15) || (startNode == 21 && neighbor == 27) || (startNode == 27 && neighbor == 21);
                    if (isBackward && (!isBridge || !targetPiece || targetPiece.team === piece.team)) return;
                    if (targetPiece && targetPiece.type === 'square') return;
                }
                if (targetPiece) {
                    if (targetPiece.team !== piece.team) valid.push(neighbor);
                    visited.set(neighbor, current.dist + 1);
                } else {
                    valid.push(neighbor); visited.set(neighbor, current.dist + 1);
                    queue.push({id: neighbor, dist: current.dist + 1, lastNode: current.id});
                }
            }
        });
    }
    return [...new Set(valid)];
}

function handleInteraction(id) {
    if (gameState.gameOver || myRole === 'spectator' || (myRole && gameState.turn !== myRole)) return;
    const target = gameState.pieces[id];
    if (target && target.team === gameState.turn) {
        gameState.selectedNode = id;
    } else if (gameState.selectedNode !== null) {
        if (getValidMoves(gameState.selectedNode).includes(id)) {
            const movingPiece = gameState.pieces[gameState.selectedNode];
            if ((target && target.type === 'king') || (movingPiece.type === 'king' && ((movingPiece.team === 'blue' && id === 43) || (movingPiece.team === 'red' && id === 0)))) {
                gameState.gameOver = true; gameState.winner = gameState.turn; showWinPopup(gameState.turn);
            }
            gameState.lastMove = {from: gameState.selectedNode, to: id};
            gameState.pieces[id] = movingPiece; delete gameState.pieces[gameState.selectedNode];
            gameState.turn = gameState.turn === 'blue' ? 'red' : 'blue'; gameState.selectedNode = null; 
            broadcastState(); updateStatus();
        } else { gameState.selectedNode = null; }
    }
    drawBoard();
}

function drawBoard(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.strokeStyle='#444';ctx.lineWidth=2.5;roads.forEach(p=>{ctx.beginPath();ctx.moveTo(nodes[p[0]].x,nodes[p[0]].y);ctx.lineTo(nodes[p[1]].x,nodes[p[1]].y);ctx.stroke()});const possible=getValidMoves(gameState.selectedNode);for(let id in nodes){const n=nodes[id], p=gameState.pieces[id], numId=parseInt(id);if(gameState.lastMove&&(gameState.lastMove.from===numId||gameState.lastMove.to===numId)){ctx.beginPath();ctx.arc(n.x,n.y,22,0,7);ctx.fillStyle='rgba(0,0,0,0.1)';ctx.fill()}if(gameState.selectedNode===numId){ctx.beginPath();ctx.arc(n.x,n.y,22,0,7);ctx.fillStyle='rgba(0,112,255,0.2)';ctx.fill()}if(possible.includes(numId)){ctx.beginPath();ctx.arc(n.x,n.y,18,0,7);ctx.fillStyle='rgba(255,215,0,0.5)';ctx.fill()}if(p&&p.type==='king'){drawHex(n.x,n.y,20);ctx.fillStyle='#fff';ctx.fill();ctx.strokeStyle=p.team=='blue'?'#2563EB':'#DC2626';ctx.lineWidth=3;ctx.stroke()}else{ctx.beginPath();ctx.arc(n.x,n.y,16,0,7);ctx.fillStyle='#fff';ctx.fill();ctx.strokeStyle=p?(p.team=='blue'?'#2563EB':'#DC2626'):'#ccc';ctx.lineWidth=2;ctx.stroke()}if(p){ctx.fillStyle=p.team=='blue'?'#2563EB':'#DC2626';ctx.font='bold 18px Arial';ctx.textAlign='center';let icon=p.type=='king'?'ðŸ‘‘':p.type=='triangle'?'â–²':p.type=='square'?'â– ':'X';ctx.fillText(icon,n.x,n.y+(p.type=='king'?7:6))}}}
function drawHex(x,y,size){ctx.beginPath();for(let i=0;i<6;i++){ctx.lineTo(x+size*Math.cos(i*Math.PI/3),y+size*Math.sin(i*Math.PI/3))}ctx.closePath()}
function toggleUI(f=false){if(f||!uiContainer.classList.contains('hidden')){uiContainer.classList.add('hidden');pullTab.innerText="â–² MENU";canvas.height=window.innerHeight}else{uiContainer.classList.remove('hidden');pullTab.innerText="â–¼ CLOSE";canvas.height=window.innerHeight-140}drawBoard()}
function triggerRestart(){if(myRole==='spectator')return;gameState=initialGameState();overlay.style.display='none';if(conn&&conn.open)conn.send("RESET_GAME");broadcastState();drawBoard();updateStatus()}
function broadcastState(){if(conn&&conn.open)conn.send(gameState);spectators.forEach(s=>{if(s.open)s.send(gameState)})}
function updateStatus(){if(gameState.gameOver)return;statusDiv.innerText=(myRole==='spectator'?"[LIVE] ":"")+gameState.turn.toUpperCase()+" TURN";statusDiv.style.color=gameState.turn==='blue'?'#2563EB':'#DC2626'}
function showWinPopup(w){winMsg.innerText=w.toUpperCase()+" WINS!";winMsg.style.color=w==='blue'?'#2563EB':'#DC2626';overlay.style.display='flex'}
function inviteTelegramFriend(t){const l=`https://t.me/Iq17game_bot/IQ17?startapp=${t==='spectator'?'spec_'+peer.id:peer.id}`;tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(l)}&text=${encodeURIComponent(t==='spectator'?"Watch live!":"Challenge me!")}`)}
function setupConnection(){conn.on('open',()=>{statusDiv.innerText=myRole==='spectator'?"SPECTATING":"CONNECTED!";invitePlayerBtn.style.display='none';if(myRole==='blue')broadcastState();else conn.send("SYNC")});conn.on('data',d=>{if(d==="SYNC"){broadcastState();return}if(d==="RESET_GAME"){gameState=initialGameState();overlay.style.display='none';drawBoard();updateStatus();return}gameState=d;spectators.forEach(s=>{if(s.open)s.send(gameState)});if(gameState.gameOver)showWinPopup(gameState.winner);drawBoard();updateStatus()})}
peer.on('open',id=>{const p=tg.initDataUnsafe.start_param;if(p){if(p.startsWith('spec_')){conn=peer.connect(p.replace('spec_',''),{metadata:{type:'spectator'},reliable:true});myRole='spectator'}else{conn=peer.connect(p,{reliable:true});myRole='red'}setupConnection()}else{statusDiv.innerText="BLUE TEAM'S TURN"}});
peer.on('connection',c=>{if(c.metadata&&c.metadata.type==='spectator'){spectators.push(c);c.on('open',()=>c.send(gameState))}else{conn=c;myRole='blue';setupConnection()}});
canvas.addEventListener('touchstart',e=>{e.preventDefault();toggleUI(true);const t=e.touches[0], r=canvas.getBoundingClientRect();const x=t.clientX-r.left, y=t.clientY-r.top;for(let id in nodes){if(Math.sqrt((x-nodes[id].x)**2+(y-nodes[id].y)**2)<30){handleInteraction(parseInt(id));break}}});
drawBoard();
</script>
</body>
</html>
